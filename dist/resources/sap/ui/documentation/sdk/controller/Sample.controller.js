/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/documentation/sdk/controller/SampleBaseController","sap/ui/model/json/JSONModel","sap/ui/core/Component","sap/ui/core/ComponentContainer","sap/ui/documentation/sdk/controller/util/ControlsInfo","sap/ui/documentation/sdk/util/ToggleFullScreenHandler","sap/m/Text","sap/ui/core/HTML","sap/m/library","sap/base/Log","sap/ui/core/Fragment","sap/ui/documentation/sdk/util/Resources"],function(e,t,i,o,n,s,a,r,l,u,d,h,p){"use strict";var m=u.URLHelper;return t.extend("sap.ui.documentation.sdk.controller.Sample",{onInit:function(){t.prototype.onInit.call(this);this.getRouter().getRoute("sample").attachPatternMatched(this._onSampleMatched,this);this.oModel=new i({showNavButton:true,showNewTab:false,rtaLoaded:false});this._sId=null;this._sEntityId=null;Promise.all([sap.ui.getCore().loadLibrary("sap.ui.fl",{async:true}),sap.ui.getCore().loadLibrary("sap.ui.rta",{async:true})]).then(this._loadRTA.bind(this));this.getView().setModel(this.oModel);this.bus=sap.ui.getCore().getEventBus();this.setDefaultSampleTheme();this.bus.subscribe("themeChanged","onDemoKitThemeChanged",this.onDemoKitThemeChanged,this)},_onSampleMatched:function(e){this._sId=e.getParameter("arguments").sampleId;this._sEntityId=e.getParameter("arguments").entityId;this.byId("page").setBusy(true);this.getModel("appView").setProperty("/bHasMaster",false);s.loadData().then(this._loadSample.bind(this))},_loadSample:function(e){var t=this.byId("page"),i=this.oModel.getData(),n=e.samples[this._sId],s;if(!n){setTimeout(function(){t.setBusy(false)},0);this.onRouteNotFound();return}this.entityId=this._sEntityId?this._sEntityId:n.entityId;i.sEntityId=this.entityId;if(n.previousSampleId||n.nextSampleId){i.previousSampleId=n.previousSampleId;i.nextSampleId=n.nextSampleId}if(n.contexts){s=n.contexts[this.entityId];if(s){i.previousSampleId=s.previousSampleId;i.nextSampleId=s.nextSampleId}else{this.onRouteNotFound();return}}i.title="Sample: "+n.name;this._createComponent().then(function(e){this.getOwnerComponent()._oCurrentOpenedSample=e?e:undefined;var s=o.get(e.getComponent());var a=s.getMetadata()?s.getMetadata().getConfig():null;var r=a&&a.sample||{};i.showNewTab=!!r.iframe||p.getHasProxy();i.id=n.id;i.name=n.name;i.details=n.details;i.description=n.description;if(r){i.stretch=r.stretch;i.includeInDownload=r.additionalDownloadFiles;if(r.files){var l=sap.ui.require.toUrl(n.id.replace(/\./g,"/"));i.files=[];for(var u=0;u<r.files.length;u++){var d=r.files[u];i.files.push({name:d});this._updateFileContent(l,d)}}if(r.iframe||p.getHasProxy()){e=this._createIframe(e,r.iframe)}else{this.sIFrameUrl=null}}i.iframe=r.iframe||p.getHasProxy();var h=!!r.stretch;var m=h?"100%":null;t.setEnableScrolling(!h);if(e.setHeight){e.setHeight(m)}t.removeAllContent();t.addContent(e);t.scrollTo(0);this.getAPIReferenceCheckPromise(n.entityId).then(function(e){this.getView().byId("apiRefButton").setVisible(e)}.bind(this));this.oModel.setData(i);this.appendPageTitle(this.getModel().getProperty("/name"))}.bind(this)).catch(function(e){t.removeAllContent();t.addContent(new r({text:"Error while loading the sample: "+e}))}).finally(function(){setTimeout(function(){t.setBusy(false)},0)})},_updateFileContent:function(e,t){this.fetchSourceFile(e+"/"+t).then(function(e){var i=this.oModel.getProperty("/files");i.some(function(i){if(i.name===t){i.raw=e;return true}});this.oModel.setProperty("/files",i)}.bind(this))},onAPIRefPress:function(){this.getRouter().navTo("apiId",{id:this.entityId})},onNewTab:function(){this._applySearchParamValueToIframeURL("sap-ui-theme",this._sDefaultSampleTheme);m.redirect(this.sIFrameUrl,true)},onPreviousSample:function(e){this.getRouter().navTo("sample",{entityId:this.entityId,sampleId:this.oModel.getProperty("/previousSampleId")})},onNextSample:function(e){this.getRouter().navTo("sample",{entityId:this.entityId,sampleId:this.oModel.getProperty("/nextSampleId")})},onInfoSample:function(e){var t=e.getSource();if(!this._oPopover){h.load({name:"sap.ui.documentation.sdk.view.samplesInfo",controller:this}).then(function(e){this.getView().addDependent(e);this._oPopover=e;this._oPopover.openBy(t)}.bind(this))}else{this._oPopover.openBy(t)}},_resolveIframePath:function(e,t){var i=t.split("/"),o;for(o=0;o<i.length-1;o++){if(i[o]==".."){e=e.substring(0,e.lastIndexOf("."))}else{e+="."+i[o]}}return e},_createIframe:function(t,i){var o=this._sId,n="",s=/\/([^\/]*)$/,a=/\..+$/,r,u,h;if(typeof i==="string"){n=this._resolveIframePath(o,i);r=s.exec(i);u=r&&r.length>1?r[1]:i;h=a.exec(u)[0];var m=u.replace(a,"");this.sIFrameUrl=sap.ui.require.toUrl((n+"/"+m).replace(/\./g,"/"))+h||".html"}else if(p.getHasProxy()){var c=p.getResourceOriginPath(sap.ui.require.toUrl(this._sId.replace(/\./g,"/"))),f=window["sap-ui-documentation-config"]&&window["sap-ui-documentation-config"].demoKitResourceOrigin||"",g=p.getResourcesVersion();this.sIFrameUrl="resources/sap/ui/documentation/sdk/index.html"+"?sap-ui-xx-sample-id="+o+"&&sap-ui-xx-sample-path="+c+"&&sap-ui-xx-sample-origin="+f+"&&sap-ui-xx-sample-version="+g}else{d.error("no iframe source was provided");return}if(!this._oHtmlControl){this._oHtmlControl=new l({id:"sampleFrame",content:'<iframe src="'+this.sIFrameUrl+'" id="sampleFrame" frameBorder="0"></iframe>'}).addEventDelegate({onAfterRendering:function(){if(!this._oHtmlControl._jQueryHTMLControlLoadEventAttached){this._oHtmlControl.$().on("load",function(){var t=this._oHtmlControl.$()[0].contentWindow,i=t.sap.ui.getCore();t.sap.ui.getCore().attachInit(function(){var o=e(document.body).hasClass("sapUiSizeCompact");i.applyTheme(p.getHasProxy()?this._sDefaultSampleTheme:this._oCore.getConfiguration().getTheme());i.getConfiguration().setRTL(this._oCore.getConfiguration().getRTL());t.jQuery("body").toggleClass("sapUiSizeCompact",o).toggleClass("sapUiSizeCozy",!o);i.notifyContentDensityChanged()}.bind(this))}.bind(this));this._oHtmlControl._jQueryHTMLControlLoadEventAttached=true}}.bind(this)})}else{this._oHtmlControl.getDomRef().src=this.sIFrameUrl}return this._oHtmlControl},_createComponent:function(){var e="sampleComp-"+this._sId;var t=this._sId;var i=this.getOwnerComponent();var s=o.get(e);if(s){s.destroy()}return i.runAsOwner(function(){return o.create({id:e,name:t}).then(function(e){return new n({component:e})})})},setDefaultSampleTheme:function(){var e=p.getResourcesVersion();this._sDefaultSampleTheme=e&&parseInt(e.slice(3,5))<68?"sap_belize":sap.ui.getCore().getConfiguration().getTheme()},onDemoKitThemeChanged:function(e,t,i){if(this._oHtmlControl){this._oHtmlControl.$()[0].contentWindow.sap.ui.getCore().applyTheme(i.sThemeActive)}this.setDefaultSampleTheme()},onNavBack:function(e){this.getRouter().navTo("entity",{id:this.entityId})},onNavToCode:function(e){this.getRouter().navTo("code",{entityId:this.entityId,sampleId:this._sId},false)},onToggleFullScreen:function(e){a.updateMode(e,this.getView(),this)},_oRTA:null,_applySearchParamValueToIframeURL:function(e,t){var i=window.URL,o;try{o=new i(this.sIFrameUrl,document.location)}catch(e){d.warning("window.URL is not supported. The search param value won't be applied.");return}this.sIFrameUrl=this.sIFrameUrl.replace(o.search,"");o.searchParams.set(e,t);this.sIFrameUrl=this.sIFrameUrl+decodeURI(o.search)},_loadRTA:function(){sap.ui.require(["sap/ui/fl/Utils","sap/ui/fl/FakeLrepConnectorLocalStorage","sap/ui/core/util/reflection/JsControlTreeModifier"],function(e,t,i){var o=this.oModel.getData();i.checkControlId=function(){return true};e.checkControlId=function(){return true};t.enableFakeConnector({isProductiveSystem:true});o.rtaLoaded=true;this.oModel.setData(o);this.getRouter().attachRouteMatched(function(){if(this._oRTA){this._oRTA.destroy();this._oRTA=null}},this)}.bind(this))},onToggleAdaptationMode:function(e){sap.ui.require(["sap/ui/rta/api/startKeyUserAdaptation"],function(e){if(!this._oRTA){e({rootControl:this.byId("page").getContent()[0].getComponentInstance()}).then(function(e){this._oRTA=e;this._oRTA.attachStop(function(){this._oRTA.destroy();delete this._oRTA}.bind(this))}.bind(this))}}.bind(this))},onRouteNotFound:function(){var e=this.getModel("i18n").getProperty("NOT_FOUND_SAMPLE_TITLE");this.getRouter().myNavToWithoutHash("sap.ui.documentation.sdk.view.SampleNotFound","XML",false);setTimeout(this.appendPageTitle.bind(this,e));return}})});