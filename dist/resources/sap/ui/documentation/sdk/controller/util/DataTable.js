/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/m/Input","sap/m/library","../config/datatable","./datatable/filters/DataTableFilterDropDown","./datatable/filters/DataTableFilterRange","sap/ui/documentation/sdk/controller/util/Highlighter","./DataTableUtil"],function(t,e,i,n,o,s,a,l){"use strict";var r=i.InputType;function h(){this.oColumns=[];this.oChangedFilters=[];this.aShownRows=[];this.API=null}h.DEFAULT_SORTING="0,asc";h.FILTER_CLASS_WRAPPER="sapUiDocumentationDatatableFilterWrapper";h.FILTER_TYPES={REGEX:"REGEX",NORMAL:"NORMAL",NUMBER:"NUMBER",SELECT:"SELECT",CELL_RANGE:"CELL_RANGE",NUMBER_RANGE:"NUMBER_RANGE"};h.prototype.destroy=function(){this.oColumns.forEach(function(t){if(t.highlighter){t.highlighter.destroy();t.highlighter=null}t.aControls.forEach(function(t){t.destroy()});t.aControls=[]});this.oColumns=[];this.API.destroy()};h.prototype.get=function(t){return this.oConfig[t]};h.prototype.init=function(e,i,n){this.sId=e;this.oDomTable=i;this.oConfig=this.getConfig(e,n);var o=t(i).DataTable(Object.assign(this.oConfig,this.getLifeCycleMethods(e,n)));o.on("draw",function(){if(this.get("highlight")){var t=o.search();if(t||this.oChangedFilters.length){this.oColumns.forEach(function(e,i){var n=this.oChangedFilters[i]&&this.oChangedFilters[i].value,o=Array.isArray(n);if(o){n=n.reduce(function(t,e,i){if(e.value){t+=" "+e.text}return t},"")}if(n&&!(typeof n==="object")){if(t){t+=" "+n}else{t=n}}this.highlight(i,t)},this)}else{this.highlight(null,"")}}}.bind(this));o.buttons().container().insertBefore("#"+e+"_length");o.on("column-visibility.dt",function(t,e,i,n){this.onColumnVisibilityChange(i,n)}.bind(this));this.oConfig.columns.forEach(function(t,e){this.onColumnVisibilityChange(e,t.visible)},this);return this};h.prototype.highlight=function(t,e){if(t===null){this.oColumns.forEach(function(t){t.highlighter.highlight(e)});return}this.oColumns[t].highlighter.highlight(e)};h.prototype.onColumnVisibilityChange=function(t,e){var i=this.oColumns[t]&&this.oColumns[t].filterHeader,n=this.oDomTable.querySelector("colgroup"),o;if(n){o=n.children[t];if(o){o.classList.toggle("hidden",!e)}}if(i){i.toggle(e)}};h.prototype.handleSearch=function(t,e,i,n,o){var s,a,l,r,u=[],c;this.oChangedFilters.forEach(function(n,o){s=e[o];l=n.value;r=n.control;if(l===""){return}switch(true){case r.hasStyleClass(h.FILTER_TYPES.REGEX):case r.hasStyleClass(h.FILTER_TYPES.NORMAL):case r.hasStyleClass(h.FILTER_TYPES.ALPHA_NUMERIC):case r.hasStyleClass(h.FILTER_TYPES.NUMBER):c=s.toLowerCase().indexOf(l.toLowerCase())>-1;break;case r.hasStyleClass(h.FILTER_TYPES.NUMBER_RANGE):var f=l.from!==""?l.from:Number.MIN_SAFE_INTEGER,g=l.to!==""?l.to:Number.MAX_SAFE_INTEGER,E=parseFloat(s)||0;c=isNaN(f)&&isNaN(g)||isNaN(f)&&E<=g||f<=E&&isNaN(g)||f<=E&&E<=g;break;case r.hasStyleClass(h.FILTER_TYPES.CELL_RANGE):var p=s.split("-"),C=parseFloat(l);c=p[0]<=C&&p[1]>=C;break;case r.hasStyleClass(h.FILTER_TYPES.SELECT):var d=l.some(function(t){return t.value});c=!d||l.findIndex(function(e){a=t.aoData[i].anCells[o].querySelectorAll("li");var n=[];if(a.length){for(var l=0;l<a.length;l++){n[l]=a[l].textContent}}else{n.push(s)}return e.value&&n.indexOf(e.text)>-1},this)>-1;break;default:c=true}u.push(c)},this);return u.indexOf(false)<0};h.prototype.getConfig=function(t,e){var i=[],o=JSON.parse(JSON.stringify(n.getPreset()));o.sapTableId=t;o.columnDefs=[];if(e){o.save=e["save"]!==false;o.searching=e["search"]!==false;o.highlight=e["highlight"]!==false;if(e["excel_export"]){o.buttons.push("csv")}if(e["paginate"]){var s=parseInt(e["paginate"]);o.pageLength=s>0?s:-1}o.columns=e.columns.map(function(t,e){var i={visible:true};i.visible=t.visible!==false;if(t.sort){var n=o.columnDefs.find(function(e){return e.type===t.sort});if(n){n.targets.push(e)}else{o.columnDefs.push({type:t.sort,targets:[e]})}}return i});e["initial_sort"]=e["initial_sort"]||h.DEFAULT_SORTING;if(e["initial_sort"]!=="none"){i=e["initial_sort"].split(";");i=i.map(function(t){return t.split(",")})}o.order=i}return o};h.prototype.onFilterChange=function(t,e){this.oChangedFilters[t]={control:e.control,value:e.value};this.API.columns(t).draw()};h.prototype.getSelectOptions=function(e){var i=[];this.API.columns(e).data().unique().sort()[0].forEach(function(e){var n;if(i.indexOf(e)>-1){return}try{n=t(e)}catch(t){n=null}if(n&&n.length>0){n.find("li").each(function(t,e){if(i.indexOf(e.textContent)<0){i.push(e.textContent)}})}else{i.push(e)}});i.sort(l.sortAlphaNumeric);return i};h.prototype.getLifeCycleMethods=function(e,i){var n=this;return{initComplete:function(){n.API=this.api();var o=t("#"+e+" thead"),s=t("<tr/>"),l,r,u=0;this.api().columns().every(function(){var e=u,o=i.columns[u],c=[],f,g=o.filter==="select";l=t("<th/>");l.addClass(h.FILTER_CLASS_WRAPPER);n.oColumns[u]={};n.oColumns[u].aControls=[];n.oColumns[u].filterHeader=l;if(n.get("highlight")){r=new a([].slice.call(this.nodes()),{useExternalStyles:false,shouldBeObserved:true,isCaseSensitive:false});n.oColumns[u].highlighter=r}if(g){c=n.getSelectOptions(u)}f=h.getFilterByType(o.filter,c);if(f.control){n.oColumns[u].aControls.push(f.control);f.control.attachEvent(f.event,function(t){n.onFilterChange(e,{value:t.getParameter("value"),control:f.control})});f.control.placeAt(l)}s.append(l);u++});o.append(s)}}};h.getFilterByType=function(t,i){var n,a="liveChange";switch(t){case"number-range":n=new s({from:new e({type:r.Number,placeholder:"From"}),to:new e({type:r.Number,placeholder:"To"})}).addStyleClass(h.FILTER_TYPES.NUMBER_RANGE);break;case"select":a="change";n=new o({options:i}).addStyleClass(h.FILTER_TYPES.SELECT);break;case"none":n="";break;default:var l=h.FILTER_TYPES.NORMAL,u=r.Text;if(t==="regex"){l=h.FILTER_TYPES.REGEX}else if(t==="cell-range"){l=h.FILTER_TYPES.CELL_RANGE;u=r.Number}else if(t==="number"){l=h.FILTER_TYPES.NUMBER;u=r.Number}n=new e({type:u,placeholder:"Filter"}).addStyleClass(l)}return{control:n,event:a}};return h});