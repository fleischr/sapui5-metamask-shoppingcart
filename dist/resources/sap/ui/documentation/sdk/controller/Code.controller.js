/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/documentation/sdk/controller/SampleBaseController","sap/ui/documentation/sdk/controller/util/ControlsInfo","sap/ui/documentation/sdk/model/formatter","sap/ui/model/json/JSONModel","sap/base/util/merge","sap/ui/core/Component","sap/ui/core/Core"],function(e,t,i,o,s,a,n,r){"use strict";return t.extend("sap.ui.documentation.sdk.controller.Code",{onInit:function(){t.prototype.onInit.call(this);this.oModel=new s;this.getView().setModel(this.oModel);this.router=this.getRouter();this.router.getRoute("code").attachPatternMatched(this.onRouteMatched,this);this.router.getRoute("codeFile").attachPatternMatched(this.onRouteMatched,this);this._aFilesAvailable=[];this._bFirstLoad=true;this.bus=r.getEventBus();this.bus.subscribe("themeChanged","onDemoKitThemeChanged",this.onDemoKitThemeChanged,this)},onDemoKitThemeChanged:function(e,t,i){this._updateCodeEditorTheme(i.sThemeActive)},onRouteMatched:function(e){var t=e.getParameter("arguments");this.showMasterSide();this._sId=t.sampleId;this._sEntityId=t.entityId;this._sFileName=o.routeParamsToFilePath(t);i.loadData().then(this._loadCode.bind(this))},_loadCode:function(e){var t=this._sFileName,i=e.samples[this._sId];if(!i||i.contexts&&!i.contexts[this._sEntityId]){this.onRouteNotFound();return}if(!this._oData||i.id!==this._oData.id){this._createComponent().then(function(e){var o=e.getMetadata();var s=[];var a=o?o.getConfig():null;this._oData={id:i.id,title:"Code: "+i.name,name:i.name,stretch:a.sample?a.sample.stretch:false,files:[],iframe:a.sample.iframe,fileName:t,includeInDownload:a.sample.additionalDownloadFiles};if(a&&a.sample&&a.sample.files){var n=sap.ui.require.toUrl(i.id.replace(/\./g,"/"));for(var r=0;r<a.sample.files.length;r++){var d=a.sample.files[r];s.push(this._updateFileContent(n,d));this._oData.files.push({name:d});this._aFilesAvailable.push(d)}}return Promise.all(s)}.bind(this)).then(this._showCode.bind(this,t))}else{this._oData.fileName=t;this._showCode(t)}},_showCode:function(e){this.getAPIReferenceCheckPromise(this._sEntityId).then(function(e){this.getView().byId("apiRefButton").setVisible(e)}.bind(this));this.oModel.setData(this._oData);if(e===undefined){e=this._getInitialFileName()}if(this._aFilesAvailable.indexOf(e)===-1){this.onRouteNotFound();return}this._updateCodeEditor(e);this._getTabHeader().setSelectedKey(e);var t=this.byId("page");t.scrollTo(0);this.appendPageTitle(this.getModel().getProperty("/title"))},_updateFileContent:function(e,t){return this.fetchSourceFile(e+"/"+t).then(function(e){this._oData.files.some(function(i){if(i.name===t){i.raw=e;i.code=this._convertCodeToHtml(e);return true}},this);this.oModel.setData(this._oData)}.bind(this))},onAPIRefPress:function(){this.getRouter().navTo("apiId",{id:this._sEntityId})},onNavBack:function(){this.router.navTo("sample",{sampleId:this._sId,entityId:this._sEntityId})},_convertCodeToHtml:function(e){e=e.toString();e=e.replace(/^function.+{/,"");e=e.replace(/}[!}]*$/,"");e=e.replace(/^[\n\s\S]*\/\/\s*CODESNIP_START\n/,"");e=e.replace(/\/\/\s*CODESNIP_END[\n\s\S]*$/,"");e=e.replace(/\t/g,"  ");return e},handleTabSelectEvent:function(e){var t=e.getParameter("selectedKey"),i=a(o.filePathToRouteParams(t),{entityId:this._sEntityId,sampleId:this._sId});this._bFirstLoad=false;this.router.navTo("codeFile",i,false)},_updateCodeEditor:function(e){var t=this._getCodeEditor(),i=t.getInternalEditorInstance(),o=i.renderer;t.setValue(this._getCode(e));t.setType(this._getFileType(e));i.gotoLine(0,0,false);if(this._bFirstLoad){setTimeout(function(){o.onResize()},0)}this._updateCodeEditorTheme(r.getConfiguration().getTheme().toLowerCase())},_updateCodeEditorTheme:function(e){var t="tomorrow";if(e.indexOf("hcb")>-1){t="chaos"}else if(e.indexOf("hcw")>-1){t="github"}else if(e==="sap_fiori_3"){t="crimson_editor"}else if(e==="sap_fiori_3_dark"){t="clouds_midnight"}this._getCodeEditor().setColorTheme(t)},_getCode:function(e){var t=this.getModel().getData().files,i="";t.forEach(function(t){if(t.name===e){i=t.raw;return true}});return i},_getFileType:function(e){var t=e.split(".").pop();return t==="js"?"javascript":t},_getInitialFileName:function(){return this._oData&&this._oData.files&&this._oData.files.length>0&&this._oData.files[0].name||null},_getCodeEditor:function(){if(!this.oCodeEditor){this.oCodeEditor=this.byId("codeEditor")}return this.oCodeEditor},_getTabHeader:function(){if(!this.oTabHeader){this.oTabHeader=this.byId("tabHeader")}return this.oTabHeader},_createComponent:function(){var e="sampleComp-"+this._sId;var t=this._sId;var i=n.get(e);if(i){i.destroy()}return n.create({id:e,name:t})}})});