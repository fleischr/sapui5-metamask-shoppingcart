/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/documentation/sdk/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/CustomData","sap/ui/documentation/sdk/controller/util/ControlsInfo","sap/ui/documentation/sdk/util/ToggleFullScreenHandler","sap/ui/documentation/sdk/controller/util/APIInfo","sap/ui/documentation/sdk/model/formatter","sap/ui/core/mvc/XMLView","sap/ui/core/library","sap/base/Log"],function(e,t,i,n,s,o,a,r,d,l){"use strict";return e.extend("sap.ui.documentation.sdk.controller.ApiDetail",{NOT_AVAILABLE:"N/A",NOT_FOUND:"Not found",onInit:function(){this.getRouter().getRoute("apiSpecialRoute").attachPatternMatched(this._onTopicMatched,this);this._oModel=new t;this._oModel.setSizeLimit(1e4);this._oContainerPage=this.getView().byId("apiDetailPageContainer")},_onTopicMatched:function(e){var t,i,n;t=this.getRouter()._decodeSpecialRouteArguments(e);i=this.getOwnerComponent();if(this._sTopicid===t.id){n=this._oView&&this._oView.getController();if(n){n.scrollToEntity(t.entityType,t.entityId)}return}this._sTopicid=t.id;this._sEntityType=t.entityType;this._sEntityId=t.entityId;if(this._oView&&!this._oView.bIsDestroyed){this._oView.destroy();this._oContainerPage.setBusy(true)}i.loadVersionInfo().then(function(){this._aAllowedMembers=this.getModel("versionData").getProperty("/allowedMembers")}.bind(this)).then(o.getIndexJsonPromise).then(this._processApiIndexAndLoadApiJson.bind(this)).then(this._findEntityInApiJsonData.bind(this)).then(this._addMissingNodesToControlData.bind(this)).then(this._buildBorrowedModel.bind(this)).then(this._createModelAndSubView.bind(this)).then(this._initSubView.bind(this)).catch(function(e){if(e===this.NOT_FOUND){this._oContainerPage.setBusy(false);this.onRouteNotFound()}else if(typeof e==="string"){l.error(e)}else if(e.name){l.error(e.name,e.message)}else if(e.message){l.error(e.message)}}.bind(this))},_initSubView:function(e){var t=e.getController();if(e.data("topicid")!==this._sTopicid){e.destroy();return}this._oView=e;this._oContainerPage.addContent(e);this._oContainerPage.setBusy(false);t.initiate({sTopicId:this._sTopicid,oModel:this._oModel,aApiIndex:this._aApiIndex,aAllowedMembers:this._aAllowedMembers,oEntityData:this._oEntityData,sEntityType:this._sEntityType,sEntityId:this._sEntityId,oOwnerComponent:this.getOwnerComponent(),oContainerView:this.getView(),oContainerController:this})},_createModelAndSubView:function(e){this._oControlData.borrowed=e;this._bindData(this._sTopicid);return r.create({height:"100%",customData:new i({key:"topicid",value:this._sTopicid}),viewName:"sap.ui.documentation.sdk.view.SubApiDetail",async:true,preprocessors:{xml:{models:{data:this._oModel}}}})},_buildBorrowedModel:function(e){this._oControlData=e;return this.buildBorrowedModel(e)},_addMissingNodesToControlData:function(e){var t,i,n,s,o;if(this._oEntityData.kind==="namespace"){o=Array.isArray(this._oEntityData.nodes)&&this._oEntityData.nodes;t=Array.isArray(e.nodes)&&e.nodes;if(o&&t&&o.length>t.length){t.sort(this._compareStringsCaseInsensitive);o.forEach(function(e,o){i=e.name;s=t[o]&&t[o].name;if(i!==s){n={};n.name=i;n.description="";n.href="api/"+i;if(e.deprecated){n.deprecated=true}t.splice(o,0,n)}})}}return e},_compareStringsCaseInsensitive:function(e,t){var i=e.name.toLowerCase(),n=t.name.toLowerCase();if(i<n){return-1}if(i>n){return 1}return 0},_filterEntityByVisibilityInApiJsonData:function(e){var t=this.getModel("versionData"),i=t.getProperty("/isInternal");if(!i){e=(e||[]).filter(function(e){return!e.hasOwnProperty("visibility")||e.visibility!=="restricted"})}return e},_findEntityInApiJsonData:function(e){var t,i,n;for(n=0,i=e.length;n<i;n++){t=e[n];if(t.name===this._sTopicid){if(t.visibility===undefined||this._aAllowedMembers.indexOf(t.visibility)>=0){return t}else{return Promise.reject(this.NOT_FOUND)}}}return Promise.reject(this.NOT_FOUND)},_processApiIndexAndLoadApiJson:function(e){var t,i,n=this._sTopicid;this._aApiIndex=e;function s(e){return e.some(function(e){var i=e.name===n;if(!i&&e.nodes){return s(e.nodes)}else if(i){t=e;return true}return false})}s(e);if(t){this._oEntityData=t;if(t.deprecated||t.bAllContentDeprecated){i=this.getOwnerComponent().getConfigUtil().getMasterView("apiId").getController();i.selectDeprecatedSymbol(this._sTopicid)}t.nodes=this._filterEntityByVisibilityInApiJsonData(t.nodes);return o.getLibraryElementsJSONPromise(t.lib).then(function(e){return Promise.resolve(e)})}return Promise.reject(this.NOT_FOUND)},_bindData:function(e){var t=this._oControlData,i,n,s=function(e,t){e=e.toLowerCase();t=t.toLowerCase();if(e>t){return 1}else if(e<t){return-1}return 0};n=t["ui5-metadata"];t.hasProperties=false;t.hasOwnMethods=false;t.hasControlProperties=false;t.hasAssociations=false;t.hasAggregations=false;t.hasSpecialSettings=false;t.hasAnnotations=false;var o=function(e){return this._aAllowedMembers.indexOf(e.visibility)>=0}.bind(this);var r=function(e){e.name&&(e.name=a.apiRefEntityName(e.name));e.code&&(e.code=a.apiRefEntityName(e.code));if(e.name){var t=e.name.replace(/[$#/]/g,".");e.placeholderId=t+"_method";e.subPlaceholderId=t+"__method"}return e};if(t.borrowed.properties.length){n=n||(t["ui5-metadata"]={});n.properties=(n.properties||[]).concat(t.borrowed.properties)}if(t.borrowed.aggregations.length){n=n||(t["ui5-metadata"]={});n.aggregations=(n.aggregations||[]).concat(t.borrowed.aggregations)}if(t.borrowed.associations.length){n=n||(t["ui5-metadata"]={});n.associations=(n.associations||[]).concat(t.borrowed.associations)}if(t.properties){t.properties=this.transformElements(t.properties,o,r);t.hasProperties=!!t.properties.length}if(t.methods){t.methods=this.transformElements(t.methods,o,r);t.hasOwnMethods=!!t.methods.length}if(n){t.dnd=n.dnd;t.hasControlProperties=!!(n.properties&&n.properties.length);t.hasAssociations=!!(n.associations&&n.associations.length);t.hasAggregations=!!(n.aggregations&&n.aggregations.length);t.hasSpecialSettings=!!(n.specialSettings&&n.specialSettings.length);t.hasAnnotations=!!(n.annotations&&n.annotations.length);if(t.hasControlProperties){n.properties=this.transformElements(n.properties,o).sort(function(e,t){return s(e.name,t.name)})}if(t.hasAssociations){n.associations=this.transformElements(n.associations,o).sort(function(e,t){return s(e.name,t.name)})}if(t.hasAggregations){n.aggregations=this.transformElements(n.aggregations,o).sort(function(e,t){return s(e.name,t.name)});t.hasAggregationAltTypes=n.aggregations.some(function(e){return!!e.altTypes})}if(t.hasSpecialSettings){n.specialSettings=this.transformElements(n.specialSettings,o).sort(function(e,t){return s(e.name,t.name)})}if(t.hasAnnotations){n.annotations=n.annotations.sort(function(e,t){return s(e.annotation,t.annotation)})}}t.nodes=this.transformElements(t.nodes||[],o).sort(function(e,t){return s(e.name,t.name)});t.hasChildren=t.nodes&&!!t.nodes.length;t.hasConstructor=t.hasOwnProperty("constructor")&&!!t.constructor;t.hasOwnEvents=!!t.events;t.hasEvents=!!(t.hasOwnEvents||t.borrowed&&t.borrowed.events.length>0);t.hasMethods=!!(t.hasOwnMethods||t.borrowed&&t.borrowed.methods.length>0);if(t.implements&&t.implements.length){t.implementsParsed=t.implements.map(function(e,t,i){var n=e.split("."),s=n[n.length-1];return{href:e,name:s}});t.hasImplementsData=true}else{t.hasImplementsData=false}t.isFunction=t.kind==="function";t.isClass=t.kind==="class";t.isNamespace=t.kind==="namespace";t.isDerived=!!t.extends;t.extendsText=t.extends||this.NOT_AVAILABLE;t.sinceText=t.since||this.NOT_AVAILABLE;t.module=t.module||this.NOT_AVAILABLE;this._oModel.setData(t);if(this.extHookbindData){this.extHookbindData(e,i)}},buildBorrowedModel:function(e){var t,i,n,s,a,r,d,l,h,u,c,m,f,p,g,_,b=[],w;if(!e){return Promise.resolve({events:[],methods:[],properties:[],aggregations:[],associations:[]})}d={methods:[],events:[],properties:[],aggregations:[],associations:[]};r=e.extends;var y=function(e){return this._aAllowedMembers.indexOf(e.visibility)!==-1}.bind(this);l=e.methods||[];h=l.map(function(e){return e.name});u=e["ui5-metadata"]&&e["ui5-metadata"].properties||[];c=u.map(function(e){return e.name});m=e["ui5-metadata"]&&e["ui5-metadata"].aggregations||[];f=m.map(function(e){return e.name});p=e["ui5-metadata"]&&e["ui5-metadata"].associations||[];g=p.map(function(e){return e.name});var A=function(e){return h.indexOf(e.name)===-1};var v=function(e){return c.indexOf(e.name)===-1&&!e.borrowedFrom&&!d.properties.some(function(t){return t.name===e.name})};var C=function(e){return f.indexOf(e.name)===-1&&!e.borrowedFrom};var E=function(e){return g.indexOf(e.name)===-1&&!e.borrowedFrom};function D(e,t){w=null;return e.some(function(e){var i=e.name===t;if(!i&&e.nodes){return D(e.nodes,t)}else if(i){w=e;return true}return false})}_=[r];while(r){D(this._aApiIndex,r);if(w){r=w.extends;if(r){_.push(r)}if(b.indexOf(w.lib)===-1){b.push(w.lib)}}else{r=false;break}}var O=b.map(function(e){return o.getLibraryElementsJSONPromise(e)});return Promise.all(O).then(function(o){var r=[],l;o.forEach(function(e){r=r.concat(e)});_.forEach(function(o){var h,u=r.length;while(u--){if(r[u].name===o){h=r[u];break}}var c=function(e){return{name:e.name,link:"api/"+o+"#methods/"+e.name}};var m=function(e){return{name:e.name,link:"api/"+o+"#events/"+e.name}};var f=function(e){return Object.assign({},e,{borrowedFrom:o})};if(h){l=h["ui5-metadata"]||[];if(e["ui5-metadata"]&&!e["ui5-metadata"].defaultAggregation&&l.defaultAggregation){e["ui5-metadata"].defaultAggregation=l.defaultAggregation}t=(h.methods||[]).filter(y).filter(A).map(c);if(t.length){d.methods.push({name:o,methods:t})}i=(h.events||[]).filter(y).map(m);if(i.length){d.events.push({name:o,events:i})}n=(l.properties||[]).filter(y).filter(v).map(f);if(n.length){d.properties=d.properties.concat(n)}s=(l.aggregations||[]).filter(y).filter(C).map(f);if(s.length){d.aggregations=d.aggregations.concat(s)}a=(l.associations||[]).filter(y).filter(E).map(f);if(a.length){d.associations=d.associations.concat(a)}}});return d})},transformElements:function(e,t,i){var n,s=e.length,o=[],a;for(n=0;n<s;n++){a=e[n];if(t&&!t(a)){continue}if(i){i(a)}o.push(a)}return o}})});