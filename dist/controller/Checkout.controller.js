sap.ui.define(["./BaseController","../model/cart","sap/ui/model/json/JSONModel","sap/ui/Device","../model/formatter","sap/m/MessageBox","sap/m/Link","sap/m/MessagePopover","sap/m/MessagePopoverItem","../model/EmailType","../model/web3helper"],function(e,t,s,a,r,i,n,o,c,d,l){"use strict";return e.extend("sap.ui.demo.cart.controller.Checkout",{types:{email:new d},formatter:r,onInit:function(){var e=this._isMetamaskInstalled();var t=this._setMetamaskInitConnectStatus(e);var a="Oxsomething";if(t==="c"){a=ethereum.selectedAddress}var r="0xsomethingelse";var i=new s({MetamaskInstalled:e,ConnectionStatus:t,UserWalletAddress:a,DestinationWalletAddress:r,SelectedChainId:"",SelectedCryptoNetwork:"Kovan",SelectedGasToken:"ETH",GasBalance:"0.0",SelectedPayment:"Credit Card",SelectedDeliveryMethod:"Standard Delivery",DifferentDeliveryAddress:false,CashOnDelivery:{FirstName:"",LastName:"",PhoneNumber:"",Email:""},InvoiceAddress:{Address:"",City:"",ZipCode:"",Country:"",Note:""},DeliveryAddress:{Address:"",Country:"",City:"",ZipCode:"",Note:""},CreditCard:{Name:"",CardNumber:"",SecurityCode:"",Expire:""},Stablecoins:[{ticker:"USDC",contractid:"0xa"},{ticker:"DAI",contractid:"0xb"},{ticker:"UST",contractid:"0xc"},{ticker:"MIM",contractid:"0xd"}],SupportedNetworks:[{}]}),n=this.byId("returnToShopButton");this.setModel(i);this._oHistory={prevPaymentSelect:null,prevDiffDeliverySelect:null};this.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");this.getRouter().getRoute("checkout").attachMatched(function(){this._setLayout("One")}.bind(this));this.getView().addEventDelegate({onAfterShow:function(){n.focus()}})},getGasBalance:function(){return l.getGasBalance()},onShowMessagePopoverPress:function(e){var t=e.getSource();var s=new n({text:"Show more information",href:"http://sap.com",target:"_blank"});var a=new c({type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}",link:s});if(!this.byId("errorMessagePopover")){var r=new o(this.createId("messagePopover"),{items:{path:"message>/",template:a},afterClose:function(){r.destroy()}});this._addDependent(r)}r.openBy(t)},_addDependent:function(e){this.getView().addDependent(e)},goToPaymentStep:function(){var e=this.getModel().getProperty("/SelectedPayment");var t=this.byId("paymentTypeStep");switch(e){case"Crypto":t.setNextStep(this.byId("cryptoStep"));break;case"Bank Transfer":t.setNextStep(this.byId("bankAccountStep"));break;case"Cash on Delivery":t.setNextStep(this.byId("cashOnDeliveryStep"));break;case"Credit Card":default:t.setNextStep(this.byId("creditCardStep"));break}},setPaymentMethod:function(){this._setDiscardableProperty({message:this.getResourceBundle().getText("checkoutControllerChangePayment"),discardStep:this.byId("paymentTypeStep"),modelPath:"/SelectedPayment",historyPath:"prevPaymentSelect"})},setDifferentDeliveryAddress:function(){this._setDiscardableProperty({message:this.getResourceBundle().getText("checkoutControllerChangeDelivery"),discardStep:this.byId("invoiceStep"),modelPath:"/DifferentDeliveryAddress",historyPath:"prevDiffDeliverySelect"})},invoiceAddressComplete:function(){var e=this.getModel().getProperty("/DifferentDeliveryAddress")?"deliveryAddressStep":"deliveryTypeStep";this.byId("invoiceStep").setNextStep(this.byId(e))},handleWizardCancel:function(){var e=this.getResourceBundle().getText("checkoutControllerAreYouSureCancel");this._handleSubmitOrCancel(e,"warning","home")},handleWizardSubmit:function(){var e=this.getResourceBundle().getText("checkoutControllerAreYouSureSubmit");this._handleSubmitOrCancel(e,"confirm","ordercompleted")},backToWizardContent:function(){this.byId("wizardNavContainer").backToPage(this.byId("wizardContentPage").getId())},_clearMessages:function(){sap.ui.getCore().getMessageManager().removeAllMessages()},onCheckStepActivation:function(e){this._clearMessages();var t=e.getSource().getId();switch(t){case this.createId("cryptoStep"):this.checkCryptoStep();break;case this.createId("creditCardStep"):this.checkCreditCardStep();break;case this.createId("cashOnDeliveryStep"):this.checkCashOnDeliveryStep();break;case this.createId("invoiceStep"):this.checkInvoiceStep();break;case this.createId("deliveryAddressStep"):this.checkDeliveryAddressStep();break}},onNetworkSelect:function(e){},detectSelectedNetwork:function(){"Please select another network. Our default is Matic"},selectNetwork:function(){},setGasBalance:async function(){var e=l.getGasBalance()},setTokenBalance:async function(e){var t=l.getContract(e);var s=l.getTokenBalance(t)},onCryptoAssetSelect:function(e){var t=this.byId("supportedCryptoAssets").getSelectedItems();console.log("ur doing amazing sweetie")},checkCreditCardStep:function(){this._checkStep("creditCardStep",["creditCardHolderName","creditCardNumber","creditCardSecurityNumber","creditCardExpirationDate"])},checkCashOnDeliveryStep:function(){this._checkStep("cashOnDeliveryStep",["cashOnDeliveryName","cashOnDeliveryLastName","cashOnDeliveryPhoneNumber","cashOnDeliveryEmail"])},checkInvoiceStep:function(){this._checkStep("invoiceStep",["invoiceAddressAddress","invoiceAddressCity","invoiceAddressZip","invoiceAddressCountry"])},checkCryptoStep:function(){this._checkStep("cryptoStep",[])},checkDeliveryAddressStep:function(){this._checkStep("deliveryAddressStep",["deliveryAddressAddress","deliveryAddressCity","deliveryAddressZip","deliveryAddressCountry"])},_checkInputFields:function(e){var t=this.getView();return e.some(function(e){var s=t.byId(e);var a=s.getBinding("value");try{a.getType().validateValue(s.getValue())}catch(e){return true}return false})},_checkStep:function(e,t){var s=this.byId("shoppingCartWizard"),a=this.byId(e),r=this._checkInputFields(t),i=!!sap.ui.getCore().getMessageManager().getMessageModel().getData().length;if(!i&&!r){s.validateStep(a)}else{s.invalidateStep(a)}},checkCompleted:function(){if(sap.ui.getCore().getMessageManager().getMessageModel().getData().length>0){i.error(this.getResourceBundle().getText("popOverMessageText"))}else{this.byId("wizardNavContainer").to(this.byId("summaryPage"))}},onReturnToShopButtonPress:function(){this._setLayout("Two");this.getRouter().navTo("home")},onMetamaskConnect:async function(){console.log("connecting metamask");try{const e=await ethereum.request({method:"eth_requestAccounts"});this._handleNewAccounts(e)}catch(e){console.error(e)}},_setDiscardableProperty:function(e){var t=this.byId("shoppingCartWizard");if(t.getProgressStep()!==e.discardStep){i.warning(e.message,{actions:[i.Action.YES,i.Action.NO],onClose:function(s){if(s===i.Action.YES){t.discardProgress(e.discardStep);this._oHistory[e.historyPath]=this.getModel().getProperty(e.modelPath)}else{this.getModel().setProperty(e.modelPath,this._oHistory[e.historyPath])}}.bind(this)})}else{this._oHistory[e.historyPath]=this.getModel().getProperty(e.modelPath)}},_handleSubmitOrCancel:function(e,t,s){i[t](e,{actions:[i.Action.YES,i.Action.NO],onClose:function(e){if(e===i.Action.YES){var t=this.byId("shoppingCartWizard");var a=this.getModel();var r=this.getOwnerComponent().getModel("cartProducts");this._navToWizardStep(this.byId("contentsStep"));t.discardProgress(t.getSteps()[0]);var n=a.getData();n.SelectedPayment="Credit Card";n.SelectedDeliveryMethod="Standard Delivery";n.DifferentDeliveryAddress=false;n.CashOnDelivery={};n.InvoiceAddress={};n.DeliveryAddress={};n.CreditCard={};a.setData(n);var o=r.getData();o.cartEntries={};o.totalPrice=0;r.setData(o);this.getRouter().navTo(s)}}.bind(this)})},_navBackToStep:function(e){var t=e.getSource().data("navBackTo");var s=this.byId(t);this._navToWizardStep(s)},_navToWizardStep:function(e){var t=this.byId("wizardNavContainer");var s=function(){this.byId("shoppingCartWizard").goToStep(e);t.detachAfterNavigate(s)}.bind(this);t.attachAfterNavigate(s);t.to(this.byId("wizardContentPage"))},_isMetamaskInstalled:function(){const{ethereum:e}=window;return Boolean(e&&e.isMetaMask)},_connectMetamask:function(){},_disconnectMetamask:function(){},_installMetamask:function(){},_setMetamaskInitConnectStatus:function(e){if(e===true){if(typeof ethereum.selectedAddress==="string"){return"c"}return"d"}else{return"i"}},_handleNewAccounts:function(e){var t=oModel.getData();var s=e[0];t.ConnectionStatus="c";t.UserWalletAddress=s;oModel.setData(t)}})});